---
# tasks file for proxmox
- name: Install non-enterprise apt source
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/pve-enterprise.list
    line: deb http://download.proxmox.com/debian buster pve-no-subscription
    state: present

- name: Remove enterprise apt repository
  ansible.builtin.replace:
    path: /etc/apt/sources.list.d/pve-enterprise.list
    regexp: ^deb https\://enterprise\.proxmox\.com/debian/pve buster pve-enterprise$
    replace: "#deb https://enterprise.proxmox.com/debian/pve buster pve-enterprise"

- name: Upgrade the OS (apt-get dist-upgrade)
  apt:
    upgrade: dist

- name: Get List of PVE Roles in JSON format
  command: pveum role list --output-format=json
  register: pve_role_list

- name: Add Packer PVE Role if it does not exist.
  command: "pve role add {{item.name}} -privs \"{{item.privs | join(' ')}}\""
  when: pve_role_list | community.general.json_query("{{role_query}}") == 0
  vars:
    role_query: "length([?roleid=='{{item.name}}'])"
  loop:
    - name: Packer
      privs:
        - VM.Config.Disk
        - VM.Config.CPU
        - VM.Config.Memory
        - Datastore.AllocateSpace
        - Sys.Modify
        - VM.Config.Options
        - VM.Allocate
        - VM.Audit
        - VM.Console
        - VM.Config.CDROM
        - VM.Config.Network
        - VM.PowerMgmt
        - VM.Config.HWType
        - VM.Monitor